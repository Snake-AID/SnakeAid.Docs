// SnakeAid â€” Snake Library (Source of Truth) + AI Model Class Mapping
// DBML: https://dbml.dbdiagram.io/docs

////////////////////////////////////////////////////////////
// 1) Core: Snake Species
////////////////////////////////////////////////////////////

Table snake_species {
  id uuid [pk]
  slug varchar(120) [not null, unique, note: "Stable identifier, e.g. cap_nia_bac, ran_rao_trau (match YOLO class_label)"]

  scientific_name varchar(255) [unique, note: "e.g. Naja kaouthia"]
  common_name_default varchar(255) [note: "Default display name"]

  venomous_level varchar(32) [not null, note: "NON_VENOMOUS | MILD | MEDIUM | HIGH | UNKNOWN"]
  risk_priority int [not null, default: 0, note: "Higher = more prominent warning/priority"]

  status varchar(24) [not null, default: "DRAFT", note: "DRAFT | REVIEWING | PUBLISHED | ARCHIVED"]
  is_active boolean [not null, default: true]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  created_by uuid
  updated_by uuid
}

Table snake_species_name {
  id uuid [pk]
  snake_species_id uuid [not null]

  language_code varchar(10) [not null, note: "vi, en, ..."]
  name varchar(255) [not null]
  name_type varchar(24) [not null, default: "COMMON", note: "COMMON | LOCAL | ALIAS | MISSPELLING"]
  is_primary boolean [not null, default: false]

  created_at timestamptz [not null, default: `now()`]

  Indexes {
    (snake_species_id, language_code)
    (snake_species_id, language_code, name) [unique]
  }
}

Table snake_media {
  id uuid [pk]
  snake_species_id uuid [not null]

  media_type varchar(16) [not null, note: "IMAGE | VIDEO"]
  url text [not null]
  caption varchar(255)
  source varchar(255)

  usage varchar(24) [not null, default: "LIBRARY", note: "LIBRARY | TRAINING | VERIFICATION"]
  is_primary boolean [not null, default: false]

  created_at timestamptz [not null, default: `now()`]

  Indexes {
    (snake_species_id, usage)
  }
}

// 1 species = 1 profile (CRUD-friendly single form; flexible via jsonb)
Table snake_identification_profile {
  snake_species_id uuid [pk]

  summary text
  key_features jsonb [note: "Flexible list/structure: colors, patterns, head shape, etc."]
  similar_species_notes text

  updated_at timestamptz [not null, default: `now()`]
}

////////////////////////////////////////////////////////////
// 2) Medical / First Aid Guideline (Versioning + Publish)
////////////////////////////////////////////////////////////

Table snake_first_aid_guideline {
  id uuid [pk]
  snake_species_id uuid [not null]

  version int [not null, default: 1]
  content_markdown text [not null]

  do_list jsonb [note: "Optional: bullet list"]
  dont_list jsonb [note: "Optional: bullet list"]
  when_to_call_emergency text

  is_published boolean [not null, default: false]
  published_at timestamptz

  created_at timestamptz [not null, default: `now()`]
  created_by uuid

  Indexes {
    (snake_species_id, version) [unique]
    (snake_species_id, is_published)
  }
}

////////////////////////////////////////////////////////////
// 3) Distribution / Risk (for map filters & analytics)
////////////////////////////////////////////////////////////

Table snake_distribution {
  id uuid [pk]
  snake_species_id uuid [not null]

  region_type varchar(24) [not null, note: "COUNTRY | PROVINCE | ECOZONE"]
  region_code varchar(64) [not null, note: "ISO country code / province code / custom code"]

  notes text
  confidence int [not null, default: 50, note: "0..100"]

  created_at timestamptz [not null, default: `now()`]

  Indexes {
    (snake_species_id)
    (region_type, region_code)
  }
}

////////////////////////////////////////////////////////////
// 4) Antivenom (Link to facility module later)
////////////////////////////////////////////////////////////

Table antivenom {
  id uuid [pk]
  name varchar(255) [not null, unique]
  manufacturer varchar(255)
  notes text
  is_active boolean [not null, default: true]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

Table snake_species_antivenom {
  snake_species_id uuid [not null]
  antivenom_id uuid [not null]

  evidence_note text

  Indexes {
    (snake_species_id, antivenom_id) [pk]
    (antivenom_id)
  }
}

////////////////////////////////////////////////////////////
// 5) AI Model + Class Mapping (YOLO data.yaml names[])
////////////////////////////////////////////////////////////

Table ai_model {
  id uuid [pk]
  name varchar(255) [not null, note: "e.g. yolo12-snakeaid"]
  version_tag varchar(64) [not null, note: "e.g. v1, 2025-12-29"]
  nc int [not null, note: "Number of classes (from data.yaml nc)"]
  is_active boolean [not null, default: true]

  trained_at timestamptz
  notes text

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  Indexes {
    (name, version_tag) [unique]
  }
}

Table ai_model_class_map {
  id uuid [pk]
  ai_model_id uuid [not null]

  class_id int [not null, note: "YOLO class index = position in names[]"]
  class_label varchar(120) [not null, note: "From data.yaml names[], e.g. cap_nia_bac"]
  snake_species_id uuid [not null]

  is_active boolean [not null, default: true]
  created_at timestamptz [not null, default: `now()`]

  Indexes {
    (ai_model_id, class_id) [unique]
    (ai_model_id, class_label)
    (snake_species_id)
  }
}

////////////////////////////////////////////////////////////
// 6) Optional: Audit Log (Source of Truth governance)
////////////////////////////////////////////////////////////

Table snake_library_audit_log {
  id uuid [pk]

  entity_type varchar(64) [not null, note: "snake_species | snake_media | snake_first_aid_guideline | ..."]
  entity_id uuid [not null]
  action varchar(24) [not null, note: "CREATE | UPDATE | DELETE | PUBLISH | ARCHIVE"]

  changed_by uuid
  changed_at timestamptz [not null, default: `now()`]

  diff_json jsonb [note: "Optional: store changed fields snapshot/diff"]
}

////////////////////////////////////////////////////////////
// Relationships
////////////////////////////////////////////////////////////

Ref: snake_species_name.snake_species_id > snake_species.id
Ref: snake_media.snake_species_id > snake_species.id
Ref: snake_identification_profile.snake_species_id > snake_species.id
Ref: snake_first_aid_guideline.snake_species_id > snake_species.id
Ref: snake_distribution.snake_species_id > snake_species.id

Ref: snake_species_antivenom.snake_species_id > snake_species.id
Ref: snake_species_antivenom.antivenom_id > antivenom.id

Ref: ai_model_class_map.ai_model_id > ai_model.id
Ref: ai_model_class_map.snake_species_id > snake_species.id
